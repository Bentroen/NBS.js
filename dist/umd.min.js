(function(g,re){typeof exports=="object"&&typeof module<"u"?re(exports):typeof define=="function"&&define.amd?define(["exports"],re):(g=typeof globalThis<"u"?globalThis:g||self,re(g.NBSjs={}))})(this,function(g){"use strict";var re=Object.defineProperty,dr=(e,t,r)=>t in e?re(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Be=(e,t,r)=>dr(e,typeof t!="symbol"?t+"":t,r);class ke{constructor(t){Be(this,"buffer"),Be(this,"viewer"),Be(this,"nextByte",0),this.buffer=t,this.viewer=new DataView(t)}}class qe extends ke{readByte(){const t=this.viewer.getInt8(this.nextByte);return this.nextByte+=1,t}readUnsingedByte(){const t=this.viewer.getUint8(this.nextByte);return this.nextByte+=1,t}readShort(){const t=this.viewer.getInt16(this.nextByte,!0);return this.nextByte+=2,t}readInt(){const t=this.viewer.getInt32(this.nextByte,!0);return this.nextByte+=4,t}readString(){const t=this.readInt();let r="";for(let n=0;n<t;n++){const a=this.readUnsingedByte();r+=String.fromCodePoint(a)}return r}}var Qe=e=>{throw TypeError(e)},Xe=(e,t,r)=>t.has(e)||Qe("Cannot "+r),pe=(e,t,r)=>(Xe(e,t,"read from private field"),r?r.call(e):t.get(e)),hr=(e,t,r)=>t.has(e)?Qe("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),fr=(e,t,r,n)=>(Xe(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r),D;class Ye extends ke{constructor(t,r=!1){super(t),hr(this,D),fr(this,D,r)}writeByte(t=0){pe(this,D)||this.viewer.setInt8(this.nextByte,Math.floor(t)),this.nextByte+=1}writeUnsignedByte(t=0){pe(this,D)||this.viewer.setUint8(this.nextByte,t),this.nextByte+=1}writeShort(t=0){pe(this,D)||this.viewer.setInt16(this.nextByte,t,!0),this.nextByte+=2}writeInt(t=0){pe(this,D)||this.viewer.setInt32(this.nextByte,t,!0),this.nextByte+=4}writeString(t=""){this.writeInt(t.length);for(const r of t)this.writeUnsignedByte(r.charCodeAt(0))}}D=new WeakMap;function w(e,{name:t,addInitializer:r}){return r(function(){const n=Object.getOwnPropertyDescriptor(this,t)??Object.getOwnPropertyDescriptor(Object.getPrototypeOf(this),t);Object.defineProperty(this,t,{...n,enumerable:!0})}),e}class Ze extends Error{constructor(t){super(`Property "${t}" is read-only and cannot be modified!`),this.name="IllegalSetError"}}function $(e,{name:t,addInitializer:r}){return r(function(){const n=Object.getOwnPropertyDescriptor(this,t)??Object.getOwnPropertyDescriptor(Object.getPrototypeOf(this),t);Object.defineProperty(this,t,{...n,set:()=>{throw new Ze(t.toString())}})}),e}var gr=Object.defineProperty,yr=(e,t,r)=>t in e?gr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,ne=(e,t,r)=>yr(e,typeof t!="symbol"?t+"":t,r);const E={key:45,velocity:100,panning:0,pitch:0};class Oe{constructor(t,r=E){ne(this,"instrument",0),ne(this,"key",E.key),ne(this,"velocity",E.velocity),ne(this,"panning",E.panning),ne(this,"pitch",E.pitch);const n={...E,...r};this.instrument=t,this.key=n.key,this.velocity=n.velocity,this.panning=n.panning,this.pitch=n.pitch}}var mr=Object.create,je=Object.defineProperty,pr=Object.getOwnPropertyDescriptor,et=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),K=e=>{throw TypeError(e)},br=(e,t,r)=>t in e?je(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,tt=(e,t)=>je(e,"name",{value:t,configurable:!0}),vr=e=>[,,,mr(e?.[et("metadata")]??null)],rt=["class","method","getter","setter","accessor","field","value","get","set"],ie=e=>e!==void 0&&typeof e!="function"?K("Function expected"):e,wr=(e,t,r,n,a)=>({kind:rt[e],name:t,metadata:n,addInitializer:s=>r._?K("Already initialized"):a.push(ie(s||null))}),nt=(e,t)=>br(t,et("metadata"),e[3]),$r=(e,t,r,n)=>{for(var a=0,s=e[t>>1],c=s&&s.length;a<c;a++)t&1?s[a].call(r):n=s[a].call(r,n);return n},Ie=(e,t,r,n,a,s)=>{var c,o,p,h,f,i=t&7,y=!!(t&8),d=!!(t&16),m=i>3?e.length+1:i?y?1:2:0,S=rt[i+5],B=i>3&&(e[m-1]=[]),C=e[m]||(e[m]=[]),u=i&&(!d&&!y&&(a=a.prototype),i<5&&(i>3||!d)&&pr(i<4?a:{get[r](){return V(this,s)},set[r](l){return it(this,s,l)}},r));i?d&&i<4&&tt(s,(i>2?"set ":i>1?"get ":"")+r):tt(a,r);for(var b=n.length-1;b>=0;b--)h=wr(i,r,p={},e[3],C),i&&(h.static=y,h.private=d,f=h.access={has:d?l=>Sr(a,l):l=>r in l},i^3&&(f.get=d?l=>(i^1?V:kr)(l,a,i^4?s:u.get):l=>l[r]),i>2&&(f.set=d?(l,v)=>it(l,a,v,i^4?s:u.set):(l,v)=>l[r]=v)),o=(0,n[b])(i?i<4?d?s:u[S]:i>4?void 0:{get:u.get,set:u.set}:a,h),p._=1,i^4||o===void 0?ie(o)&&(i>4?B.unshift(o):i?d?s=o:u[S]=o:a=o):typeof o!="object"||o===null?K("Object expected"):(ie(c=o.get)&&(u.get=c),ie(c=o.set)&&(u.set=c),ie(c=o.init)&&B.unshift(c));return i||nt(e,a),u&&je(a,r,u),d?i^4?s:u:a},Pe=(e,t,r)=>t.has(e)||K("Cannot "+r),Sr=(e,t)=>Object(t)!==t?K('Cannot use the "in" operator on this value'):e.has(t),V=(e,t,r)=>(Pe(e,t,"read from private field"),r?r.call(e):t.get(e)),Br=(e,t,r)=>t.has(e)?K("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),it=(e,t,r,n)=>(Pe(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r),kr=(e,t,r)=>(Pe(e,t,"access private method"),r),at,st,ot,N,U;class _{constructor(){$r(U,5,this),Br(this,N,{})}get total(){return Object.keys(V(this,N)).length}get ticks(){return Object.keys(V(this,N)).map(t=>+t)}get get(){return Object.freeze({...V(this,N)})}set(t,r){return V(this,N)[t]=r,r}add(t,r){return this.set(t,r)}create(t,r,n=E){const a=new Oe(r,n);return this.add(t,a)}delete(t){delete V(this,N)[t]}*[(ot=[w,$],st=[w,$],at=[w,$],Symbol.iterator)](){for(const[t,r]of Object.entries(V(this,N)))yield[+t,r]}}U=vr(null),N=new WeakMap,Ie(U,2,"total",ot,_),Ie(U,2,"ticks",st,_),Ie(U,2,"get",at,_),nt(U,_);var Or=Object.create,Ce=Object.defineProperty,jr=Object.getOwnPropertyDescriptor,lt=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),J=e=>{throw TypeError(e)},ct=(e,t,r)=>t in e?Ce(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,ut=(e,t)=>Ce(e,"name",{value:t,configurable:!0}),Ir=e=>[,,,Or(e?.[lt("metadata")]??null)],dt=["class","method","getter","setter","accessor","field","value","get","set"],ae=e=>e!==void 0&&typeof e!="function"?J("Function expected"):e,Pr=(e,t,r,n,a)=>({kind:dt[e],name:t,metadata:n,addInitializer:s=>r._?J("Already initialized"):a.push(ae(s||null))}),ht=(e,t)=>ct(t,lt("metadata"),e[3]),Cr=(e,t,r,n)=>{for(var a=0,s=e[t>>1],c=s&&s.length;a<c;a++)t&1?s[a].call(r):n=s[a].call(r,n);return n},Fr=(e,t,r,n,a,s)=>{var c,o,p,h,f,i=t&7,y=!!(t&8),d=!!(t&16),m=i>3?e.length+1:i?y?1:2:0,S=dt[i+5],B=i>3&&(e[m-1]=[]),C=e[m]||(e[m]=[]),u=i&&(!d&&!y&&(a=a.prototype),i<5&&(i>3||!d)&&jr(i<4?a:{get[r](){return Ae(this,s)},set[r](l){return ft(this,s,l)}},r));i?d&&i<4&&ut(s,(i>2?"set ":i>1?"get ":"")+r):ut(a,r);for(var b=n.length-1;b>=0;b--)h=Pr(i,r,p={},e[3],C),i&&(h.static=y,h.private=d,f=h.access={has:d?l=>Ar(a,l):l=>r in l},i^3&&(f.get=d?l=>(i^1?Ae:Wr)(l,a,i^4?s:u.get):l=>l[r]),i>2&&(f.set=d?(l,v)=>ft(l,a,v,i^4?s:u.set):(l,v)=>l[r]=v)),o=(0,n[b])(i?i<4?d?s:u[S]:i>4?void 0:{get:u.get,set:u.set}:a,h),p._=1,i^4||o===void 0?ae(o)&&(i>4?B.unshift(o):i?d?s=o:u[S]=o:a=o):typeof o!="object"||o===null?J("Object expected"):(ae(c=o.get)&&(u.get=c),ae(c=o.set)&&(u.set=c),ae(c=o.init)&&B.unshift(c));return i||ht(e,a),u&&Ce(a,r,u),d?i^4?s:u:a},se=(e,t,r)=>ct(e,typeof t!="symbol"?t+"":t,r),Fe=(e,t,r)=>t.has(e)||J("Cannot "+r),Ar=(e,t)=>Object(t)!==t?J('Cannot use the "in" operator on this value'):e.has(t),Ae=(e,t,r)=>(Fe(e,t,"read from private field"),r?r.call(e):t.get(e)),Lr=(e,t,r)=>t.has(e)?J("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),ft=(e,t,r,n)=>(Fe(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r),Wr=(e,t,r)=>(Fe(e,t,"access private method"),r),gt,Le,be;const M={name:void 0,isLocked:!1,isSolo:!1,volume:100,stereo:0};gt=[$,w];class oe{constructor(t=M){Cr(be,5,this),Lr(this,Le,new _),se(this,"name",M.name),se(this,"isLocked",M.isLocked),se(this,"isSolo",M.isSolo),se(this,"volume",M.volume),se(this,"stereo",M.stereo);const r={...M,...t};this.name=r.name,this.isLocked=r.isLocked,this.isSolo=r.isSolo,this.volume=r.volume,this.stereo=r.stereo}get notes(){return Ae(this,Le)}}be=Ir(null),Le=new WeakMap,Fr(be,2,"notes",gt,oe),ht(be,oe);var Tr=Object.create,We=Object.defineProperty,Er=Object.getOwnPropertyDescriptor,yt=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),R=e=>{throw TypeError(e)},Vr=(e,t,r)=>t in e?We(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,mt=(e,t)=>We(e,"name",{value:t,configurable:!0}),Nr=e=>[,,,Tr(e?.[yt("metadata")]??null)],pt=["class","method","getter","setter","accessor","field","value","get","set"],le=e=>e!==void 0&&typeof e!="function"?R("Function expected"):e,Mr=(e,t,r,n,a)=>({kind:pt[e],name:t,metadata:n,addInitializer:s=>r._?R("Already initialized"):a.push(le(s||null))}),bt=(e,t)=>Vr(t,yt("metadata"),e[3]),zr=(e,t,r,n)=>{for(var a=0,s=e[t>>1],c=s&&s.length;a<c;a++)t&1?s[a].call(r):n=s[a].call(r,n);return n},vt=(e,t,r,n,a,s)=>{var c,o,p,h,f,i=t&7,y=!!(t&8),d=!!(t&16),m=i>3?e.length+1:i?y?1:2:0,S=pt[i+5],B=i>3&&(e[m-1]=[]),C=e[m]||(e[m]=[]),u=i&&(!d&&!y&&(a=a.prototype),i<5&&(i>3||!d)&&Er(i<4?a:{get[r](){return F(this,s)},set[r](l){return wt(this,s,l)}},r));i?d&&i<4&&mt(s,(i>2?"set ":i>1?"get ":"")+r):mt(a,r);for(var b=n.length-1;b>=0;b--)h=Mr(i,r,p={},e[3],C),i&&(h.static=y,h.private=d,f=h.access={has:d?l=>Dr(a,l):l=>r in l},i^3&&(f.get=d?l=>(i^1?F:Kr)(l,a,i^4?s:u.get):l=>l[r]),i>2&&(f.set=d?(l,v)=>wt(l,a,v,i^4?s:u.set):(l,v)=>l[r]=v)),o=(0,n[b])(i?i<4?d?s:u[S]:i>4?void 0:{get:u.get,set:u.set}:a,h),p._=1,i^4||o===void 0?le(o)&&(i>4?B.unshift(o):i?d?s=o:u[S]=o:a=o):typeof o!="object"||o===null?R("Object expected"):(le(c=o.get)&&(u.get=c),le(c=o.set)&&(u.set=c),le(c=o.init)&&B.unshift(c));return i||bt(e,a),u&&We(a,r,u),d?i^4?s:u:a},Te=(e,t,r)=>t.has(e)||R("Cannot "+r),Dr=(e,t)=>Object(t)!==t?R('Cannot use the "in" operator on this value'):e.has(t),F=(e,t,r)=>(Te(e,t,"read from private field"),r?r.call(e):t.get(e)),xr=(e,t,r)=>t.has(e)?R("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),wt=(e,t,r,n)=>(Te(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r),Kr=(e,t,r)=>(Te(e,t,"access private method"),r),$t,St,A,ce;class ue{constructor(){zr(ce,5,this),xr(this,A,[])}get total(){return F(this,A).length}get get(){return Object.freeze([...F(this,A)])}create(){const t=new oe;return F(this,A)[F(this,A).length]=t,t}add(t){F(this,A)[F(this,A).length]=t}delete(t){F(this,A).splice(t,1)}[(St=[w,$],$t=[w,$],Symbol.iterator)](){return F(this,A).values()}}ce=Nr(null),A=new WeakMap,vt(ce,2,"total",St,ue),vt(ce,2,"get",$t,ue),bt(ce,ue);var Ur=Object.create,Ee=Object.defineProperty,_r=Object.getOwnPropertyDescriptor,Bt=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),G=e=>{throw TypeError(e)},kt=(e,t,r)=>t in e?Ee(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Ot=(e,t)=>Ee(e,"name",{value:t,configurable:!0}),Jr=e=>[,,,Ur(e?.[Bt("metadata")]??null)],jt=["class","method","getter","setter","accessor","field","value","get","set"],de=e=>e!==void 0&&typeof e!="function"?G("Function expected"):e,Rr=(e,t,r,n,a)=>({kind:jt[e],name:t,metadata:n,addInitializer:s=>r._?G("Already initialized"):a.push(de(s||null))}),It=(e,t)=>kt(t,Bt("metadata"),e[3]),Pt=(e,t,r,n)=>{for(var a=0,s=e[t>>1],c=s&&s.length;a<c;a++)t&1?s[a].call(r):n=s[a].call(r,n);return n},Ct=(e,t,r,n,a,s)=>{var c,o,p,h,f,i=t&7,y=!!(t&8),d=!!(t&16),m=i>3?e.length+1:i?y?1:2:0,S=jt[i+5],B=i>3&&(e[m-1]=[]),C=e[m]||(e[m]=[]),u=i&&(!d&&!y&&(a=a.prototype),i<5&&(i>3||!d)&&_r(i<4?a:{get[r](){return he(this,s)},set[r](l){return Ne(this,s,l)}},r));i?d&&i<4&&Ot(s,(i>2?"set ":i>1?"get ":"")+r):Ot(a,r);for(var b=n.length-1;b>=0;b--)h=Rr(i,r,p={},e[3],C),i&&(h.static=y,h.private=d,f=h.access={has:d?l=>Gr(a,l):l=>r in l},i^3&&(f.get=d?l=>(i^1?he:Hr)(l,a,i^4?s:u.get):l=>l[r]),i>2&&(f.set=d?(l,v)=>Ne(l,a,v,i^4?s:u.set):(l,v)=>l[r]=v)),o=(0,n[b])(i?i<4?d?s:u[S]:i>4?void 0:{get:u.get,set:u.set}:a,h),p._=1,i^4||o===void 0?de(o)&&(i>4?B.unshift(o):i?d?s=o:u[S]=o:a=o):typeof o!="object"||o===null?G("Object expected"):(de(c=o.get)&&(u.get=c),de(c=o.set)&&(u.set=c),de(c=o.init)&&B.unshift(c));return i||It(e,a),u&&Ee(a,r,u),d?i^4?s:u:a},ve=(e,t,r)=>kt(e,typeof t!="symbol"?t+"":t,r),Ve=(e,t,r)=>t.has(e)||G("Cannot "+r),Gr=(e,t)=>Object(t)!==t?G('Cannot use the "in" operator on this value'):e.has(t),he=(e,t,r)=>(Ve(e,t,"read from private field"),r?r.call(e):t.get(e)),Ft=(e,t,r)=>t.has(e)?G("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),Ne=(e,t,r,n)=>(Ve(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r),Hr=(e,t,r)=>(Ve(e,t,"access private method"),r),At,Lt,we,H,$e;const Wt={0:{name:"Harp",soundFile:"harp.ogg"},1:{name:"Double Bass",soundFile:"dbass.ogg"},2:{name:"Bass Drum",soundFile:"bdrum.ogg"},3:{name:"Snare Drum",soundFile:"sdrum.ogg"},4:{name:"Click",soundFile:"click.ogg"},5:{name:"Guitar",soundFile:"guitar.ogg"},6:{name:"Flute",soundFile:"flute.ogg"},7:{name:"Bell",soundFile:"bell.ogg"},8:{name:"Chime",soundFile:"icechime.ogg"},9:{name:"Xylophone",soundFile:"xylobone.ogg"},10:{name:"Iron Xylophone",soundFile:"iron_xylophone.ogg"},11:{name:"Cow Bell",soundFile:"cow_bell.ogg"},12:{name:"Didgeridoo",soundFile:"didgeridoo.ogg"},13:{name:"Bit",soundFile:"bit.ogg"},14:{name:"Banjo",soundFile:"banjo.ogg"},15:{name:"Pling",soundFile:"pling.ogg"}},T={name:"",soundFile:"",key:45,pressKey:!1};Lt=[w,$],At=[w,$];const z=class ur{constructor(t=T){Pt(H,5,this),Ft(this,$e,!1),ve(this,"name"),ve(this,"soundFile"),ve(this,"key",T.key),ve(this,"pressKey",T.pressKey);const r={...T,...t};this.name=r.name??T.name,this.soundFile=r.soundFile??T.soundFile,this.pressKey=r.pressKey??T.pressKey,this.key=r.key??T.key}static get builtIn(){return Object.freeze({...he(ur,we)})}get isBuiltIn(){return he(this,$e)}};H=Jr(null),we=new WeakMap,$e=new WeakMap,Ct(H,10,"builtIn",Lt,z),Ct(H,2,"isBuiltIn",At,z),It(H,z),Pt(H,3,z),Ft(z,we,Object.fromEntries(Object.entries(Wt).map(([e,t])=>{const r=new z(t);return Ne(r,$e,!0),[e,r]}))),he(z,we)[0].pressKey=!0;let x=z;var qr=Object.create,Me=Object.defineProperty,Qr=Object.getOwnPropertyDescriptor,Tt=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),q=e=>{throw TypeError(e)},Xr=(e,t,r)=>t in e?Me(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Et=(e,t)=>Me(e,"name",{value:t,configurable:!0}),Yr=e=>[,,,qr(e?.[Tt("metadata")]??null)],Vt=["class","method","getter","setter","accessor","field","value","get","set"],fe=e=>e!==void 0&&typeof e!="function"?q("Function expected"):e,Zr=(e,t,r,n,a)=>({kind:Vt[e],name:t,metadata:n,addInitializer:s=>r._?q("Already initialized"):a.push(fe(s||null))}),Nt=(e,t)=>Xr(t,Tt("metadata"),e[3]),en=(e,t,r,n)=>{for(var a=0,s=e[t>>1],c=s&&s.length;a<c;a++)t&1?s[a].call(r):n=s[a].call(r,n);return n},ze=(e,t,r,n,a,s)=>{var c,o,p,h,f,i=t&7,y=!!(t&8),d=!!(t&16),m=i>3?e.length+1:i?y?1:2:0,S=Vt[i+5],B=i>3&&(e[m-1]=[]),C=e[m]||(e[m]=[]),u=i&&(!d&&!y&&(a=a.prototype),i<5&&(i>3||!d)&&Qr(i<4?a:{get[r](){return I(this,s)},set[r](l){return zt(this,s,l)}},r));i?d&&i<4&&Et(s,(i>2?"set ":i>1?"get ":"")+r):Et(a,r);for(var b=n.length-1;b>=0;b--)h=Zr(i,r,p={},e[3],C),i&&(h.static=y,h.private=d,f=h.access={has:d?l=>tn(a,l):l=>r in l},i^3&&(f.get=d?l=>(i^1?I:rn)(l,a,i^4?s:u.get):l=>l[r]),i>2&&(f.set=d?(l,v)=>zt(l,a,v,i^4?s:u.set):(l,v)=>l[r]=v)),o=(0,n[b])(i?i<4?d?s:u[S]:i>4?void 0:{get:u.get,set:u.set}:a,h),p._=1,i^4||o===void 0?fe(o)&&(i>4?B.unshift(o):i?d?s=o:u[S]=o:a=o):typeof o!="object"||o===null?q("Object expected"):(fe(c=o.get)&&(u.get=c),fe(c=o.set)&&(u.set=c),fe(c=o.init)&&B.unshift(c));return i||Nt(e,a),u&&Me(a,r,u),d?i^4?s:u:a},De=(e,t,r)=>t.has(e)||q("Cannot "+r),tn=(e,t)=>Object(t)!==t?q('Cannot use the "in" operator on this value'):e.has(t),I=(e,t,r)=>(De(e,t,"read from private field"),r?r.call(e):t.get(e)),Mt=(e,t,r)=>t.has(e)?q("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),zt=(e,t,r,n)=>(De(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r),rn=(e,t,r)=>(De(e,t,"access private method"),r),Dt,xt,Kt,L,xe,Q;class X{constructor(){en(Q,5,this),Mt(this,L,{...x.builtIn}),Mt(this,xe,+Object.keys(x.builtIn).at(-1)+1)}get total(){return Object.keys(I(this,L)).length}get get(){return Object.freeze({...I(this,L)})}get firstCustomIndex(){return I(this,xe)}set(t,r){if(I(this,L)[t]?.isBuiltIn){console.warn("Built-in instruments cannot be modified!");return}if(!I(this,L)[t-1])throw new Error("Instrument cannot be set out of order! There must be an instrument before or on this ID.");return I(this,L)[t]=r,r}add(t){return this.set(this.total,t)}create(t){const r=new x(t);return this.add(r)}delete(t){if(I(this,L)[t]?.isBuiltIn){console.warn("Built-in instruments cannot be deleted!");return}delete I(this,L)[t]}*[(Kt=[w,$],xt=[w,$],Dt=[w,$],Symbol.iterator)](){for(const[t,r]of Object.entries(I(this,L)))yield[+t,r]}}Q=Yr(null),L=new WeakMap,xe=new WeakMap,ze(Q,2,"total",Kt,X),ze(Q,2,"get",xt,X),ze(Q,2,"firstCustomIndex",Dt,X),Nt(Q,X);var nn=Object.create,Ke=Object.defineProperty,an=Object.getOwnPropertyDescriptor,Ut=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),Y=e=>{throw TypeError(e)},_t=(e,t,r)=>t in e?Ke(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Jt=(e,t)=>Ke(e,"name",{value:t,configurable:!0}),sn=e=>[,,,nn(e?.[Ut("metadata")]??null)],Rt=["class","method","getter","setter","accessor","field","value","get","set"],ge=e=>e!==void 0&&typeof e!="function"?Y("Function expected"):e,on=(e,t,r,n,a)=>({kind:Rt[e],name:t,metadata:n,addInitializer:s=>r._?Y("Already initialized"):a.push(ge(s||null))}),Gt=(e,t)=>_t(t,Ut("metadata"),e[3]),ln=(e,t,r,n)=>{for(var a=0,s=e[t>>1],c=s&&s.length;a<c;a++)t&1?s[a].call(r):n=s[a].call(r,n);return n},W=(e,t,r,n,a,s)=>{var c,o,p,h,f,i=t&7,y=!!(t&8),d=!!(t&16),m=i>3?e.length+1:i?y?1:2:0,S=Rt[i+5],B=i>3&&(e[m-1]=[]),C=e[m]||(e[m]=[]),u=i&&(!d&&!y&&(a=a.prototype),i<5&&(i>3||!d)&&an(i<4?a:{get[r](){return P(this,s)},set[r](l){return ee(this,s,l)}},r));i?d&&i<4&&Jt(s,(i>2?"set ":i>1?"get ":"")+r):Jt(a,r);for(var b=n.length-1;b>=0;b--)h=on(i,r,p={},e[3],C),i&&(h.static=y,h.private=d,f=h.access={has:d?l=>cn(a,l):l=>r in l},i^3&&(f.get=d?l=>(i^1?P:un)(l,a,i^4?s:u.get):l=>l[r]),i>2&&(f.set=d?(l,v)=>ee(l,a,v,i^4?s:u.set):(l,v)=>l[r]=v)),o=(0,n[b])(i?i<4?d?s:u[S]:i>4?void 0:{get:u.get,set:u.set}:a,h),p._=1,i^4||o===void 0?ge(o)&&(i>4?B.unshift(o):i?d?s=o:u[S]=o:a=o):typeof o!="object"||o===null?Y("Object expected"):(ge(c=o.get)&&(u.get=c),ge(c=o.set)&&(u.set=c),ge(c=o.init)&&B.unshift(c));return i||Gt(e,a),u&&Ke(a,r,u),d?i^4?s:u:a},j=(e,t,r)=>_t(e,typeof t!="symbol"?t+"":t,r),Ue=(e,t,r)=>t.has(e)||Y("Cannot "+r),cn=(e,t)=>Object(t)!==t?Y('Cannot use the "in" operator on this value'):e.has(t),P=(e,t,r)=>(Ue(e,t,"read from private field"),r?r.call(e):t.get(e)),Z=(e,t,r)=>t.has(e)?Y("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),ee=(e,t,r,n)=>(Ue(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r),un=(e,t,r)=>(Ue(e,t,"access private method"),r),Ht,qt,Qt,Xt,Yt,Zt,er,tr,rr,nr,_e,Je,ye,te,me,Re,O;const ir={enabled:!1,interval:10},ar={enabled:!1,startTick:0,totalLoops:0};nr=[w,$],rr=[w,$],tr=[w,$],er=[w,$],Zt=[w,$],Yt=[w],Xt=[w],Qt=[w,$],qt=[w,$],Ht=[w,$];class k{constructor(){ln(O,5,this),Z(this,_e,{...ar}),Z(this,Je,{...ir}),Z(this,ye,10),Z(this,te,100),Z(this,me,new ue),Z(this,Re,new X),j(this,"nbsVersion",5),j(this,"name"),j(this,"author"),j(this,"originalAuthor"),j(this,"description"),j(this,"importName"),j(this,"minutesSpent",0),j(this,"leftClicks",0),j(this,"rightClicks",0),j(this,"blocksAdded",0),j(this,"blocksRemoved",0),j(this,"timeSignature",4)}get length(){let t=0;for(const r of P(this,me).get){const n=+Object.keys(r.notes.get).at(-1);n>t&&(t=n)}return t}get loop(){return P(this,_e)}get autoSave(){return P(this,Je)}get duration(){return this.length*P(this,te)}get lastMeasure(){return Math.ceil(this.length/this.timeSignature)*this.timeSignature}get tempo(){return P(this,ye)}set tempo(t){ee(this,ye,t),ee(this,te,20/t*50)}get timePerTick(){return P(this,te)}set timePerTick(t){ee(this,te,t),ee(this,ye,50/t*20)}get hasSolo(){let t=!1;for(const r of P(this,me).get)if(r.isSolo){t=!0;break}return t}get instruments(){return P(this,Re)}get layers(){return P(this,me)}}O=sn(null),_e=new WeakMap,Je=new WeakMap,ye=new WeakMap,te=new WeakMap,me=new WeakMap,Re=new WeakMap,W(O,2,"length",nr,k),W(O,2,"loop",rr,k),W(O,2,"autoSave",tr,k),W(O,2,"duration",er,k),W(O,2,"lastMeasure",Zt,k),W(O,2,"tempo",Yt,k),W(O,2,"timePerTick",Xt,k),W(O,2,"hasSolo",Qt,k),W(O,2,"instruments",qt,k),W(O,2,"layers",Ht,k),Gt(O,k);function Se(e,t=!0){let r=e;t&&(r=Object.assign({},e),Object.setPrototypeOf(r,k.prototype));for(let n=r.layers.total-1;n>0;n--)r.layers.get[n].notes.total===0&&r.layers.delete(n);return r}const sr={ignoreEmptyLayers:!1};function dn(e,t=sr){let r=e;t.ignoreEmptyLayers&&(r=Se(e));const n=or(r,0,!0).nextByte;return or(r,n).buffer}function or(e,t,r=!1){const n=new Ye(new ArrayBuffer(t),r);e.nbsVersion>=1&&(n.writeShort(0),n.writeByte(e.nbsVersion),n.writeByte(e.instruments.firstCustomIndex)),(e.nbsVersion===0||e.nbsVersion>=3)&&n.writeShort(e.length),n.writeShort(e.layers.total),n.writeString(e.name??""),n.writeString(e.author??""),n.writeString(e.originalAuthor??""),n.writeString(e.description??""),n.writeShort(e.tempo*100),n.writeByte(+e.autoSave.enabled),n.writeByte(e.autoSave.interval),n.writeByte(e.timeSignature),n.writeInt(Math.floor(e.minutesSpent)),n.writeInt(e.leftClicks),n.writeInt(e.rightClicks),n.writeInt(e.blocksAdded),n.writeInt(e.blocksRemoved),n.writeString(e.importName??""),e.nbsVersion>=4&&(n.writeByte(+e.loop.enabled),n.writeByte(e.loop.totalLoops),n.writeByte(e.loop.startTick)),n.writeByte(0);let a=-1;for(let c=0;c<=e.length;c++){let o=!1;for(const f of e.layers.get)if(f.notes.get[c]){o=!0;break}if(!o)continue;const p=c-a;a=c,n.writeShort(p);let h=-1;for(let f=0;f<e.layers.total;f++){const i=e.layers.get[f].notes.get[c];if(i){const y=f-h;h=f,n.writeShort(y),n.writeByte(i.instrument),n.writeByte(i.key),e.nbsVersion>=4&&(n.writeByte(i.velocity),n.writeUnsignedByte((i.panning??0)+100),n.writeShort(i.pitch))}}n.writeShort(0)}n.writeShort(0);for(const c of e.layers.get){if(n.writeString(c.name??""),e.nbsVersion>=4){let o=0;c.isLocked&&(o=1),c.isSolo&&(o=2),n.writeByte(o)}n.writeByte(c.volume),e.nbsVersion>=2&&n.writeByte(c.stereo+100)}const s=Object.keys(e.instruments.get).length;n.writeByte(s-e.instruments.firstCustomIndex);for(let c=0;c<s;c++){const o=e.instruments.get[c];o.isBuiltIn||(n.writeString(o.name??""),n.writeString(o.soundFile),n.writeByte(o.key),n.writeByte(+(o.pressKey??0)))}return n}const Ge={pressKey:!1,isLocked:!1,isSolo:!1,volume:0,stereo:0,velocity:100,panning:0,pitch:0,isBuiltIn:!0};function hn(e){const t=Se(e);return JSON.parse(JSON.stringify(t,(r,n)=>{if(!(Ge[r]!==void 0&&n===Ge[r]))return n}))}const lr={ignoreEmptyLayers:!1};function fn(e,t=lr){const r=new k,n=new qe(e);let a=n.readShort();if(a===0?(r.nbsVersion=n.readByte(),n.readByte(),r.nbsVersion>=3&&(a=n.readShort())):r.nbsVersion=0,r.nbsVersion>5)throw new Error("This library does not support Note Block Songs created with versions greater than 5.");const s=n.readShort();r.name=n.readString(),r.author=n.readString(),r.originalAuthor=n.readString(),r.description=n.readString(),r.tempo=n.readShort()/100,r.autoSave.enabled=!!n.readByte(),r.autoSave.interval=n.readByte(),r.timeSignature=n.readByte(),r.minutesSpent=n.readInt(),r.leftClicks=n.readInt(),r.rightClicks=n.readInt(),r.blocksAdded=n.readInt(),r.blocksRemoved=n.readInt(),r.importName=n.readString();for(const h of["name","author","originalAuthor","description","importName"])r[h]===""&&(r[h]=void 0);r.nbsVersion>=4&&(r.loop.enabled=!!n.readByte(),r.loop.totalLoops=n.readByte(),r.loop.startTick=n.readShort());const c=[];let o=-1;for(;;){const h=n.readShort();if(h===0)break;o+=h;let f=-1;for(;;){const i=n.readShort();if(i===0)break;f+=i;const y=n.readByte(),d=n.readByte();let m=100,S=0,B=0;r.nbsVersion>=4&&(m=n.readByte(),S=n.readUnsingedByte()-100,B=n.readShort()),c.push({instrument:y,key:d,velocity:m,panning:S,pitch:B,layer:f,tick:o})}}if(r.nbsVersion>0&&r.nbsVersion<3&&(a=o),e.byteLength>n.nextByte)for(let h=0;h<s;h++){const f=r.layers.create(),i=n.readString();if(f.name=i===""?void 0:i,r.nbsVersion>=4){const d=n.readByte();d===1&&(f.isLocked=!0),d===2&&(f.isSolo=!0)}f.volume=n.readByte();let y=0;r.nbsVersion>=2&&(y=n.readUnsingedByte()-100),f.stereo=y}const p=n.readByte();for(let h=0;h<p;h++){const f=n.readString();r.instruments.set(r.instruments.firstCustomIndex+h,new x({name:f===""?void 0:f,soundFile:n.readString(),key:n.readByte(),pressKey:!!n.readByte()}))}for(const h of c){let f=r.layers.get[h.layer];f||(f=r.layers.create()),f.notes.create(h.tick,h.instrument,{key:h.key,panning:h.panning,pitch:h.pitch,velocity:h.velocity})}return t.ignoreEmptyLayers?Se(r,!1):r}function cr(e,t,r){for(const n of Object.keys(r)){if(e.includes(n))continue;const a=typeof t[n],s=typeof r[n];if(a==="object"&&s==="object"){cr(e,t[n],r[n]);continue}a!=="undefined"&&a!==s||(t[n]=r[n])}}function He(e,t,r,n){n in r&&typeof r[n]=="object"&&"get"in r[n]&&e(r[n].get)&&t(r[n].get)}function gn(e){if(typeof e!="object")throw new Error("Provided argument is not a valid JSON object!");const t=new k,r=[],n=Object.getPrototypeOf(t);for(const a of Object.getOwnPropertyNames(n)){if(a==="loop"||a==="autoSave")continue;const s=Object.getOwnPropertyDescriptor(t,a);s&&typeof s.set=="function"&&r.push(a)}return cr(r,t,e),"tempo"in e&&typeof e.tempo=="number"?t.tempo=e.tempo:"timePerTick"in e&&typeof e.timePerTick=="number"&&(t.timePerTick=e.timePerTick),He(Array.isArray,a=>{for(const s of a){const c=new oe(s);He(o=>typeof o=="object",o=>{for(const[p,h]of Object.entries(o))typeof h=="object"&&(!("instrument"in h)||typeof h.instrument!="number"||c.notes.set(+p,new Oe(h.instrument,h)))},s,"notes"),t.layers.add(c)}},e,"layers"),He(a=>typeof a=="object",a=>{const s=Object.entries(a);if(s.length>Object.keys(x.builtIn).length)for(const[c,o]of s)!("isBuiltIn"in o)||o.isBuiltIn==="true"||t.instruments.set(+c,new x(o))},e,"instruments"),t}g.BufferReader=qe,g.BufferWrapper=ke,g.BufferWriter=Ye,g.IllegalSetError=Ze,g.Instrument=x,g.Layer=oe,g.LayerNotes=_,g.Note=Oe,g.Song=k,g.SongInstruments=X,g.SongLayers=ue,g.builtInBuilder=Wt,g.defaultAutoSave=ir,g.defaultFromArrayBufferOptions=lr,g.defaultInstrumentOptions=T,g.defaultLayerOptions=M,g.defaultLoop=ar,g.defaultNoteOptions=E,g.defaultToArrayBufferOptions=sr,g.enumerable=w,g.fromArrayBuffer=fn,g.fromJSON=gn,g.ignoredValues=Ge,g.omitEmptyLayers=Se,g.readOnly=$,g.toArrayBuffer=dn,g.toJSON=hn});
